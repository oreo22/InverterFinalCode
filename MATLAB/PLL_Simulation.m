sineTable =[0.001533, 0.003065,0.004597,0.006130,0.007662,0.009195,0.010727,0.01226,0.013792,0.015324,0.016857,0.018389,0.019921,0.021453,0.022985,0.024517,0.026049,0.027581,0.029113,0.030645,0.032177,0.033708,0.03524, ...
0.036771, 0.038303,0.039834,0.041365,0.042896,0.044427,0.045958,0.047489,0.04902,0.05055,0.052081,0.053611,0.055142,0.056672,0.058202,0.059731, ...
0.061261,0.062791,0.06432,0.065849,0.067378,0.068907,0.070436,0.071965,0.073493,0.075021,0.076549,0.078077,0.079605,0.081132,0.08266,0.084187, ...
0.085714,0.087241,0.088767,0.090293,0.09182,0.093345,0.094871,0.096397,0.097922,0.099447,0.100972,0.102496,0.10402,0.105545,0.107068,0.108592, ...
0.110115,0.111638,0.113161,0.114683,0.116206, 0.117728,0.119249,0.120771,0.122292,0.123813,0.125333,0.126854,0.128373,0.129893,0.131412,0.132932, ...
0.13445,0.135969,0.137487,0.139005,0.140522,0.142039,0.143556,0.145072,0.146588,0.148104,0.14962,0.151135,0.152649,0.154164,0.155678,0.157191, ...
0.158705,0.160217,0.16173,0.163242,0.164754,0.166265,0.167776,0.169287,0.170797,0.172307,0.173816,0.175325,0.176833,0.178342,0.179849,0.181357, ...
0.182863,0.18437,0.185876,0.187381,0.188886,0.190391,0.191895,0.193399,0.194902,0.196405,0.197908,0.19941,0.200911,0.202412,0.203913,0.205413, ...
0.206912,0.208411,0.20991,0.211408,0.212906,0.214403,0.215899,0.217395,0.218891,0.220386,0.221881,0.223375,0.224868,0.226361,0.227854,0.229345, ...
0.230837,0.232328,0.233818,0.235308,0.236797,0.238285,0.239774,0.241261,0.242748,0.244234,0.24572,0.247205,0.24869,0.250174,0.251657,0.25314, ...
0.254623,0.256104,0.257585,0.259066,0.260546,0.262025,0.263504,0.264982,0.266459,0.267936,0.269412,0.270887,0.272362,0.273836,0.27531,0.276783, ...
0.278255,0.279727,0.281198,0.282668,0.284138,0.285607,0.287075,0.288543,0.29001,0.291476,0.292942,0.294407,0.295871,0.297334,0.298797,0.300259, ...
0.301721,0.303181,0.304641,0.306101,0.307559,0.309017,0.310474,0.311931,0.313386,0.314841,0.316295,0.317749,0.319201,0.320653,0.322105,0.323555, ...
0.325005,0.326454,0.327902,0.329349,0.330796,0.332241,0.333687,0.335131,0.336574,0.338017,0.339459,0.3409,0.34234,0.34378,0.345218,0.346656, ...
0.348093,0.34953,0.350965,0.3524,0.353833,0.355266,0.356698,0.35813,0.35956,0.36099,0.362418,0.363846,0.365273,0.366699,0.368125,0.369549,0.370973, ...
0.372395,0.373817,0.375238,0.376658,0.378077,0.379496,0.380913,0.38233,0.383745,0.38516,0.386574,0.387987,0.389398,0.39081,0.39222,0.393629,0.395037, ...
0.396445,0.397851,0.399257,0.400661,0.402065,0.403467,0.404869,0.40627,0.40767,0.409069,0.410467,0.411864,0.41326,0.414655,0.416049,0.417442,0.418834, ...
0.420225,0.421615,0.423004,0.424392,0.425779,0.427165,0.428551,0.429935,0.431318,0.4327,0.434081,0.435461,0.43684,0.438218,0.439595,0.440971,0.442346, ...
0.44372,0.445093,0.446465,0.447835,0.449205,0.450574,0.451941,0.453308,0.454673,0.456038,0.457401,0.458763,0.460124,0.461484,0.462843,0.464201,0.465558,0.466914,0.468268,0.469622,0.470974,0.472326,0.473676,0.475025,0.476373,0.47772,0.479066,0.48041,0.481754,0.483096,0.484437,0.485777,0.487116,0.488454,0.489791,0.491126,0.492461,0.493794,0.495126,0.496457,0.497786,0.499115,0.500442,0.501769,0.503094,0.504417,0.50574,0.507062,0.508382,0.509701,0.511019,0.512335,0.513651,0.514965,0.516278,0.51759,0.518901,0.52021,0.521518,0.522825,0.524131,0.525435,0.526739,0.528041,0.529342,0.530641,0.531939,0.533237,0.534532,0.535827,0.53712,0.538412,0.539703,0.540992,0.542281,0.543568,0.544853,0.546138,0.547421,0.548703,0.549983,0.551262,0.55254,0.553817,0.555092,0.556366,0.557639,0.558911,0.560181,0.56145,0.562717,0.563983,0.565248,0.566512,0.567774,0.569035,0.570294,0.571552,0.572809,0.574065,0.575319,0.576572,0.577823,0.579073,0.580322,0.581569,0.582815,0.58406,0.585303,0.586545,0.587785,0.589024,0.590262,0.591499,0.592733,0.593967,0.595199,0.59643,0.597659,0.598887,0.600114,0.601339,0.602563,0.603785,0.605006,0.606225,0.607444,0.60866,0.609875,0.611089,0.612301,0.613512,0.614722,0.61593,0.617136,0.618342,0.619545,0.620747,0.621948,0.623147,0.624345,0.625542,0.626737,0.62793,0.629122,0.630312,0.631501,0.632689,0.633875,0.635059,0.636243,0.637424,0.638604,0.639783,0.64096,0.642135,0.643309,0.644482,0.645653,0.646822,0.64799,0.649157,0.650322,0.651485,0.652647,0.653807,0.654966,0.656123,0.657279,0.658433,0.659586,0.660737,0.661886,0.663034,0.664181,0.665326,0.666469,0.667611,0.668751,0.66989,0.671027,0.672162,0.673296,0.674428,0.675559,0.676688,0.677816,0.678941,0.680066,0.681189,0.68231,0.683429,0.684547,0.685663,0.686778,0.687891,0.689003,0.690113,0.691221,0.692328,0.693433,0.694536,0.695638,0.696738,0.697836,0.698933,0.700028,0.701122,0.702214,0.703304,0.704393,0.70548,0.706565,0.707648,0.70873,0.709811,0.710889,0.711966,0.713042,0.714115,0.715187,0.716257,0.717326,0.718393,0.719458,0.720522,0.721583,0.722644,0.723702,0.724759,0.725814,0.726867,0.727919,0.728969,0.730017,0.731063,0.732108,0.733151,0.734193,0.735232,0.73627,0.737306,0.738341,0.739373,0.740404,0.741433,0.742461,0.743487,0.744511,0.745533,0.746553,0.747572,0.748589,0.749604,0.750618,0.751629,0.752639,0.753647,0.754654,0.755658,0.756661,0.757662,0.758662,0.759659,0.760655,0.761649,0.762641,0.763631,0.76462,0.765607,0.766591,0.767575,0.768556,0.769536,0.770513,0.771489,0.772463,0.773436,0.774406,0.775375,0.776342,0.777307,0.77827,0.779231,0.780191,0.781149,0.782104,0.783059,0.784011,0.784961,0.78591,0.786856,0.787801,0.788744,0.789685,0.790624,0.791562,0.792497,0.793431,0.794363,0.795293,0.796221,0.797147,0.798072,0.798994,0.799915,0.800833,0.80175,0.802665,0.803578,0.804489,0.805399,0.806306,0.807212,0.808115,0.809017,0.809917,0.810815,0.811711,0.812605,0.813497,0.814387,0.815276,0.816162,0.817047,0.817929,0.81881,0.819689,0.820566,0.821441,0.822314,0.823185,0.824054,0.824921,0.825786,0.82665,0.827511,0.828371,0.829228,0.830084,0.830937,0.831789,0.832639,0.833486,0.834332,0.835176,0.836018,0.836858,0.837696,0.838531,0.839365,0.840198,0.841028,0.841856,0.842682,0.843506,0.844328,0.845148,0.845966,0.846782,0.847597,0.848409,0.849219,0.850027,0.850834,0.851638,0.85244,0.85324,0.854038,0.854835,0.855629,0.856421,0.857211,0.857999,0.858786,0.85957,0.860352,0.861132,0.86191,0.862686,0.86346,0.864232,0.865002,0.86577,0.866536,0.8673,0.868062,0.868821,0.869579,0.870335,0.871088,0.87184,0.87259,0.873337,0.874083,0.874826,0.875567,0.876307,0.877044,0.877779,0.878512,0.879243,0.879972,0.880699,0.881424,0.882147,0.882868,0.883586,0.884303,0.885017,0.88573,0.88644,0.887148,0.887855,0.888559,0.889261,0.889961,0.890658,0.891354,0.892048,0.892739,0.893429,0.894116,0.894801,0.895485,0.896166,0.896845,0.897521,0.898196,0.898869,0.899539,0.900208,0.900874,0.901538,0.9022,0.90286,0.903518,0.904174,0.904827,0.905479,0.906128,0.906775,0.90742,0.908063,0.908704,0.909342,0.909979,0.910613,0.911246,0.911876,0.912504,0.913129,0.913753,0.914375,0.914994,0.915611,0.916226,0.916839,0.91745,0.918059,0.918665,0.91927,0.919872,0.920472,0.921069,0.921665,0.922259,0.92285,0.923439,0.924026,0.924611,0.925194,0.925774,0.926352,0.926929,0.927503,0.928074,0.928644,0.929211,0.929777,0.93034,0.9309,0.931459,0.932016,0.93257,0.933122,0.933672,0.93422,0.934765,0.935309,0.93585,0.936389,0.936925,0.93746,0.937992,0.938522,0.93905,0.939576,0.9401,0.940621,0.94114,0.941657,0.942172,0.942684,0.943194,0.943702,0.944208,0.944712,0.945213,0.945712,0.946209,0.946704,0.947197,0.947687,0.948175,0.948661,0.949144,0.949626,0.950105,0.950582,0.951057,0.951529,0.951999,0.952467,0.952933,0.953396,0.953858,0.954317,0.954774,0.955228,0.95568,0.95613,0.956578,0.957024,0.957467,0.957908,0.958347,0.958784,0.959218,0.95965,0.96008,0.960507,0.960933,0.961356,0.961776,0.962195,0.962611,0.963025,0.963437,0.963846,0.964254,0.964658,0.965061,0.965462,0.96586,0.966256,0.966649,0.967041,0.96743,0.967816,0.968201,0.968583,0.968963,0.969341,0.969716,0.970089,0.97046,0.970829,0.971195,0.971559,0.971921,0.97228,0.972638,0.972993,0.973345,0.973695,0.974044,0.974389,0.974733,0.975074,0.975413,0.975749,0.976084,0.976416,0.976745,0.977073,0.977398,0.977721,0.978041,0.97836,0.978675,0.978989,0.9793,0.97961,0.979916,0.980221,0.980523,0.980823,0.98112,0.981415,0.981708,0.981999,0.982287,0.982573,0.982857,0.983138,0.983417,0.983694,0.983969,0.984241,0.984511,0.984778,0.985043,0.985306,0.985567,0.985825,0.986081,0.986335,0.986586,0.986835,0.987082,0.987326,0.987568,0.987808,0.988045,0.98828,0.988513,0.988744,0.988972,0.989198,0.989421,0.989642,0.989861,0.990078,0.990292,0.990504,0.990713,0.99092,0.991125,0.991328,0.991528,0.991726,0.991922,0.992115,0.992306,0.992494,0.99268,0.992864,0.993046,0.993225,0.993402,0.993577,0.993749,0.993919,0.994086,0.994252,0.994415,0.994575,0.994733,0.994889,0.995043,0.995194,0.995343,0.99549,0.995634,0.995776,0.995915,0.996052,0.996187,0.99632,0.99645,0.996578,0.996703,0.996827,0.996947,0.997066,0.997182,0.997296,0.997407,0.997516,0.997623,0.997728,0.99783,0.997929, ...
0.998027,0.998122,0.998215,0.998305,0.998393,0.998479,0.998562,0.998643,0.998722,0.998798,0.998872,0.998943,0.999013,0.99908,0.999144,0.999206,0.999266,0.999324,0.999379,0.999432,0.999482,0.99953,0.999576,0.99962,0.999661,0.999699,0.999736,0.99977, ...
0.999802,0.999831,0.999858,0.999883,0.999905,0.999925,0.999943,0.999958,0.999971,0.999981,0.999989,0.999995,0.999999];

%PLL Modelling starts from here
Fs=60000; %Sampling frequency = 50Khz
GridFreq=60; %Nominal Grid Frequency in Hz
Tfinal=0.5; %Time the simulation is run for = 0.5 seconds
Ts=1/Fs; %Sampling Time = 1/Fs
t=0:Ts:Tfinal; %Simulation Time vector
wn=2*pi*GridFreq; %Nominal Grid Frequency in radians
%generate input signal and create a fi object of it
%input wave with a phase jump at the mid point of simulation
% CASE 1 : Phase Jump at the Mid Point
L=length(t);
for n=1:floor(L)
u(n)=sin(2*pi*GridFreq*Ts*n);
u(n)=(u(n)*0.5)+0.5;
end
for n=1:floor(L)
u1(n)=sin(2*pi*GridFreq*Ts*n);
%u1(n)=(u1(n)*0.5)+0.5;
end
for n=floor(L/2):L
u(n)=sin(2*pi*GridFreq*Ts*n+pi/2);
u(n)=(u(n)*0.5)+0.5;
end


%CASE 2 : Harmonics
% L=length(t);
% for n=1:floor(L)
% u(n)=0.9*sin(2*pi*GridFreq*Ts*n)+0.1*sin(2*pi*5*GridFreq*Ts*n);
% end
% for n=1:floor(L)
% u1(n)=sin(2*pi*GridFreq*Ts*n);
% end
%CASE 3 : Frequency Shift
% L=length(t);
% for n=1:floor(L)
% u(n)=sin(2*pi*GridFreq*Ts*n);
% end
% for n=1:floor(L)
% u1(n)=sin(2*pi*GridFreq*Ts*n);
% end
% for n=floor(L/2):L
% u(n)=sin(2*pi*GridFreq*1.1*Ts*n);
% end
%CASE 4: Amplitude Variations
% L=length(t);
% for n=1:floor(L)
% u(n)=sin(2*pi*GridFreq*Ts*n);
% end
% for n=1:floor(L)
% u1(n)=sin(2*pi*GridFreq*Ts*n);
% end
% for n=floor(L/2):L
% u(n)=0.8*sin(2*pi*GridFreq*Ts*n);
% end;
%declare arrays used by the PLL process
Upd=[0,0,0];
ynotch=[0,0,0];
ynotch_buff=[0,0,0];
ylf=[0,0];
SinGen=[0,0];
Plot_Var=[0,0];
Mysin=[0,0];
Mycos=[1.0,1.0];
theta=[0,0];
werror=[0,0];
%notch filter design
c1=0.1;
c2=0.00001;
X=2*c2*wn*2*Ts;
Y=2*c1*wn*2*Ts;
Z=wn*2*wn*2*Ts*Ts;
B_notch=[1 (X-2) (-X+Z+1)];
A_notch=[1 (Y-2) (-Y+Z+1)];
% simulate the PLL process
u(1)=(u(1)-0.5)*2;
for n=2:Tfinal/Ts % No of iteration of the PLL process in the simulation time
% Phase Detect
u(n)=(u(n)-0.5)*2;
Upd(1)= u(n)*Mycos(2);
%Notch Filter
ynotch(1)=-A_notch(2)*ynotch(2)-A_notch(3)*ynotch(3)+B_notch(1)*Upd(1)+B_notch(2)*Upd(2)+B_notch(3)*Upd(3);
%update the Upd array for future sample
Upd(3)=Upd(2);
Upd(2)=Upd(1);
% PI Loop Filter
%ts=30ms, damping ration = 0.7
% we get natural frequency = 110, Kp=166.6 and Ki=27755.55
% B0=166.877556 & B1=-166.322444
ylf(1)= 1.0*ylf(2)+166.877556*ynotch(1)-166.322444*ynotch(2);
wo=wn+ylf(1);
%werror(n+1)=(wo-wn)*0.00318309886;
Q2PI=2*pi;
QPI2=pi/2;
Q3PI2=(3*pi)/2;
PI=pi;
%% VCO

	%Put in the phase shift: Phase angle (deg) ? = time delay ? t × frequency f × 360
degreeDesired=0; %13.5; %changed in var control %the board introduces a 13.5 phase shift. it's been corrected to the best of my abilities, but still
newTimeShift=(degreeDesired*PI)/180;

%compute theta value 
theta(1)=theta(2)+wo*Ts; %*(0.159154943)
if(theta(1)>(6.2832)) %greater than 2 pi
    theta(1)=(0.0);
end

% %output phase reset condition
% if(Mysin(1)>0 && Mysin(2) <=0)
% theta(1)=-pi;
% end

%	if(theta(1)<(-6.2832)) %greater than 2 pi
%		theta(1)=(0.0);
%	
	
	

%	%% Convert theta into an index to read table, goes from 0 to 2 pi. i go from 0 to 1 or 0 to QPI2 
%  % Update phase accumulator and extract the sine table index from it
%   % Mysin(1)=sin(theta(1));
%   %  Mycos(1)=cos(theta(1));

%% Sine Lookup Time (borrowed from PLL.c)

% sinTheta=theta(1);
% 	
% 	
% %	if(s_index==99)
% %			bool fun=false;
% %	
% sineSign=1;
%     if(theta(1) > (QPI2) && theta(1)< (PI)) %Q2
%        sinTheta=PI-theta(1);
%     end	
%     
%     if(theta(1)> PI && theta(1)< (Q3PI2)) %Q3
%         sinTheta=theta(1)-PI;
%        sineSign=-1;
%     end
%     if(theta(1)> (Q3PI2) && theta(1) < (Q2PI)) %Q4
%         sinTheta=(Q2PI)-theta(1);
% 
%         sineSign=-1;
%     end
% 	
%     sinTheta=sinTheta*(2/PI); % sinIndex=sinTheta*(2/pi);
% 
%     sinIndex=ceil((sinTheta*(1023)))+1; %indexing in matlab is different than normal coding languages
%     
% 	Mysin(1)= sineSign*sineTable(sinIndex);
% 
% 
% 
% 		%sinewave[s_index]=Mysin(1);
% % 		s_index = (s_index + 1) % (100);
% % 		if(s_index==99)
% % 			bool fun=false;
% %         end
% % 		
% 		%		new_Mag=sineSign*(sineTable[sinIndex]);
% 
% 		
% 	% Looking up the phase shifted VCO output
% 		
%  
% 		sineSign=1;
%     cosIndex=theta(1)+(QPI2); %changing the theta for cos
%     if(cosIndex>(Q2PI)) %Q1
%         cosIndex=cosIndex-(Q2PI);
%     end
%     if(cosIndex> (QPI2) && cosIndex< (PI)) %Q2
%        cosIndex=PI-cosIndex;
%     end
%     if(cosIndex> PI && cosIndex< (Q3PI2))%Q3
%         cosIndex=cosIndex-PI;
%            sineSign=-1;
%     end
%     if(cosIndex> (Q3PI2) && cosIndex < (Q2PI)) %Q4
%         cosIndex=(Q2PI)-cosIndex;
%            sineSign=-1;
%     end
%     cosIndex=cosIndex*(2/PI);
% 		cosTheta=ceil(cosIndex*(1023)+1);
% 		Mycos(1)=sineSign*(sineTable(cosTheta));
% 		
% 		%Do the same thing again for phase shifted VCO
% 		sinTheta=theta(1)+newTimeShift;
% 		sineSign=1;
%     if(sinTheta>(Q2PI)) %Q1
%         sinTheta=sinTheta-(Q2PI);
%     end
%     if(sinTheta> (QPI2) && sinTheta< (PI))
%        sinTheta=PI-sinTheta;
%     end	
%     
%     if(sinTheta> PI && sinTheta< (Q3PI2)) %Q3
%         sinTheta=sinTheta-PI;
%        sineSign=-1;
%     end
%     if(sinTheta> (Q3PI2) && sinTheta < (Q2PI)) %Q4
%         sinTheta=(Q2PI)-sinTheta;
%         sineSign=-1;
%     end
%     sinTheta=sinTheta*(2/PI);
%     sinIndex=ceil(sinTheta*(1023))+1;
% 		new_Mag=sineSign*(sineTable(sinIndex));
% 		new_Mag=(new_Mag+1)/2;
% 		inputValue=(3300*(new_Mag)); %modulate the size of the sine wave here with ma 


        
%integration process
Mysin(1)=Mysin(2)+wo*Ts*(Mycos(2));
Mycos(1)=Mycos(2)-wo*Ts*(Mysin(2));
%limit the oscillator integrators
Mysin(1)=max([Mysin(1) -1.0]);
Mysin(1)=min([Mysin(1) 1.0]);
Mycos(1)=max([Mycos(1) -1.0]);
Mycos(1)=min([Mycos(1) 1.0]);

SinGen(n+1)=Mycos(1);
Plot_Var(n+1)=Mysin(1);

%Time to Update Coefficients
% update the Upd array for future
Upd(3)=Upd(2);
Upd(2)=Upd(1);

%update Ynotch for future use
ynotch(3)=ynotch(2);
ynotch(2)=ynotch(1);
%ynotch_buff(n+1)=ynotch(1);
%ylf(1)=min([ylf(1) 200.0]);
ylf(2)=ylf(1);

%update theta
theta(2)=theta(1);
%update the history of the sin and cos
Mysin(2)=Mysin(1);
Mycos(2)=Mycos(1);
end
% CASE 1 : Phase Jump at the Mid Point
error=Plot_Var-u;
%CASE 2 : Harmonics
%error=Plot_Var-u1;
%CASE 3: Frequency Variations
%error=Plot_Var-u;
%CASE 4: Amplitude Variations
%error=Plot_Var-u1;
figure;
ha(1)=subplot(3,1,1),plot(t,Plot_Var,'r',t,u,'b'),title('SPLL(red) & Ideal Grid(blue)');
ha(2)=subplot(3,1,2),plot(t,error,'r'),title('Error');
ha(3)=subplot(3,1,3),plot(t,u1,'r',t,Plot_Var,'b'),title('SPLL Out(Blue) & Ideal Grid(Red)');
linkaxes(ha, 'x');      % Link all axes in x
